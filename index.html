<html>

  <style>
    body{
      left:0px;
      top:0px;
      margin:0px;
    }
  </style>
  <body>

<script src="lib/three.js"></script>
<script src="lib/jquery.min.js"></script>
<script src="lib/TrackballControls.js"></script>
<script src="lib/MouseMoveControls.js"></script>
<script src="lib/ShaderLoader.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/dat.gui.min.js"></script>
<script src="lib/GUI.js"></script>
<script src="lib/Tween.js"></script>
<script src="SnowflakeGeometry.js"></script>

<script>

    var scene, camera, renderer;
    var geometry, material, mesh;
    var controls;

    var snowflake;

    var growSpeed = 200;
    var shrinkSpeed = 100;

    var shaders = new ShaderLoader('shaders');

    var gui = new dat.GUI();

    shaders.load( 'vs-snow' , 'snow' , 'vertex'   );
    shaders.load( 'fs-snow' , 'snow' , 'fragment' );

    shaders.shaderSetLoaded = function(){
      init();
      animate();
    }


    var matcap = THREE.ImageUtils.loadTexture( 'img/rough-aluminium.jpg' );
    var uniforms = {
      t_matcap:{type:"t" , value:matcap},
      filled:{type:"f" , value:0}
    }

    var PARAMS = {

      guide:{
        
        lengthRandomness: .5,
        lengthMultiplier: .5,
        heightRandomness: .5,
        heightMultiplier: .5,
        widthRandomness: .5,
        widthMultiplier: .5,
        branchLateness: 0,//1.8,
        branches: 2,
        maxDepth: 6,
        branchChance: .6,
        minChildren: 10,
        maxChildren: 20,
        length: 1.,
        width: 1.,
        height: .1,
        position: 0,

      },

      guideRanges:{

        lengthRandomness: [ 0  , 1  ],
        lengthMultiplier: [ 0  , 1  ],
        heightRandomness: [ 0  , 1  ],
        heightMultiplier: [ 0  , 1  ],
        widthRandomness:  [ 0  , 1  ],
        widthMultiplier:  [ 0  , 1  ],
        branchLateness:   [ 0  , 1  ],//1.8,
        branches:         [ 1  , 20 ],
        maxDepth:         [ 1  , 10 ],
        branchChance:     [ 0  , 1  ],
        minChildren:      [ 1  , 10 ],
        maxChildren:      [ 11 , 30 ],
        length:           [ .1 , 2 ],
        width:            [ .1 , 2 ],
        height:           [ .1 , .2 ],
        position:         [  0 , 1 ]

      },

      branch:{

        length: 50,
        width:  40,
        height: 100,
        extraH:.5, 
        vDepth: .2,

        lengthRandomness: .00001,
        widthRandomness: .0001,
        heightRandomness: .0001,
        angleRange:.01
        
      },

      branchRanges:{

        length: [ 20 , 100 ],
        width:  [ 10 , 60 ],
        height: [ 5 , 50  ],
        extraH: [ 0 , .5 ], 
        vDepth: [ 0 , .5 ],

        lengthRandomness: [ 0.00001 , .1 ],
        widthRandomness: [ 0.00001 , .1 ],
        heightRandomness: [ 0.00001 , .1 ],
        angleRange:[ 0.00001 , .1 ],        
      },

      randomSnowflake: function(){ nextSnowflake( true ); },
      nextSnowflake: function(){ nextSnowflake(); },

    }

    function init() {

      initGUI();


      renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
     
      window.addEventListener( 'resize', onWindowResize , false );

      document.body.appendChild( renderer.domElement );

          scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 30, 30000 );
      camera.position.z = 250;

      controls = new THREE.MouseMoveControls( camera , renderer.domElement );




      var attributes = {
        normal:{type:"v3" , value:null },
        fade: { type:"f" , value:null },
        edge: { type:"f" , value:null },
        id: { type:"f" , value:null }
      }
      var vs = shaders.vs.snow;
      var fs = shaders.fs.snow;
  
      snowflakeMaterial = new THREE.ShaderMaterial({

        attributes: attributes,
        uniforms:   uniforms,
        vertexShader: vs,
        fragmentShader: fs,
        transparent: true,

      });

      nextSnowflake();


     // uniforms.filled.value = PARAMS.guide.maxDepth*2;
    }


    function createSnowflake(){

      var geometry = new SnowflakeGeometry(
        PARAMS.guide,
        PARAMS.branch
      );

      snowflake = new THREE.Mesh( geometry , snowflakeMaterial );
      scene.add( snowflake );

      var i = { v: 0 };
      var f = { v: PARAMS.guide.maxDepth * 2 }

      var t = new TWEEN.Tween( i ).to( f , (PARAMS.guide.maxDepth * 2 ) * growSpeed );

      t.onUpdate( function(){
        uniforms.filled.value = i.v;
      });

      t.onComplete( function(){

        snowflakeFinished();

      });

      t.start();

    }

    function removeSnowflake( callback ){

      var i = { v: uniforms.filled.value };
      var f = { v: 0 }

      var t = new TWEEN.Tween( i ).to( f , i.v * shrinkSpeed );

      t.onUpdate( function(){
        uniforms.filled.value = i.v;
      });

      t.onComplete( function(){

        scene.remove( snowflake );
        snowflakeDestroyed();
        if( callback ) callback();

      });

      t.start();

    }

    function nextSnowflake( random ){

      if( snowflake ){

        removeSnowflake(function(){

          if( random ) randomize();
          createSnowflake();

        });

      }else{
      
        if( random ) randomize();
        createSnowflake();

      }

    }


    function snowflakeFinished(){   snowflakeTweening = false; }
    function snowflakeDestroyed(){  snowflakeTweening = false; }


    function initGUI(){

     // gui = new dat.GUI({ autoplace: false });

      var guides = gui.addFolder( 'guide');

      for( var propt in PARAMS.guide ){

        var range = PARAMS.guideRanges[ propt ];

        if( range ){
          guides.add( PARAMS.guide , propt , range[0] , range[1] ).listen();
        }

      }

      var branches = gui.addFolder( 'branch');

      for( var propt in PARAMS.branch ){

        var range = PARAMS.branchRanges[ propt ];

        if( range ){
          branches.add( PARAMS.branch , propt , range[0] , range[1] ).listen();
        }

      }


      gui.add( PARAMS , 'nextSnowflake' );
      gui.add( PARAMS , 'randomSnowflake' );


    }
    
    function randomize(){

      for( var propt in PARAMS.guide ){

        var range = PARAMS.guideRanges[ propt ];

        if( range ){
        var v = range[0] + Math.random() * (range[1] - range[0])
        PARAMS.guide[ propt ] = v;

        }

      }

      for( var propt in PARAMS.branch ){

        var range = PARAMS.branchRanges[ propt ];

        if( range ){
        var v = range[0] + Math.random() * (range[1] - range[0])
        PARAMS.branch[ propt ] = v;

        }

      }

    }

    function animate() {

        requestAnimationFrame( animate );

        controls.update();
        TWEEN.update();
       // mesh.rotation.x += 0.01;
       // mesh.rotation.y += 0.02;

    /*   if( filling == true ){
          uniforms.filled.value += .03;
       }else{
          uniforms.filled.value -= .03;
       }*/

        renderer.render( scene, camera );

    }

      // Resets the renderer to be the proper size
  function onWindowResize(){

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();


    renderer.setSize( window.innerWidth, window.innerHeight );
   
    var dpr = devicePixelRatio || 1;

    //camUniforms.SS.value.x = window.innerWidth * dpr;
    //camUniforms.SS.value.y = window.innerHeight * dpr;


  }
  </script>

</body>
</html>
